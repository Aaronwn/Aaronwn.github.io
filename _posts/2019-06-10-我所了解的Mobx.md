---
layout:     post
title:      我所了解的Mobx
subtitle:   聊聊工作中用到的Mobx
date:       2018-06-10
author:     Aaronwn
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - mobx
---


Redux是一个数据管理层，被广泛用于管理复杂应用的数据。但是实际使用中，Redux的表现差强人意，可以说是不好用。而同时，社区也出现了一些数据管理的方案，Mobx就是其中之一。

### mobx中核心概念

#### 1、可观察的状态 observable

包装对象值的 Observable ，核心原理是 Object.defineProperty ，给被包装的属性套上 get 和 set 的钩子，在 get 中响应依赖收集，在 set 中触发监听函数。

#### 2、依赖收集 autorun
autorun 是个神奇的函数，被他包装过的方法，就会变为观察者函数，并且这里有一个很重要的特性，这个函数只会观察自己依赖到的设为 observable 的值。

例如
```js
autorun(function(){  
    console.log(person.name);
});
```
假设person对象身上有很多个属性是 observable 的，修改这些属性值的时候不会触发 autorun 包装过的函数，只有修改 name 属性的时候才会触发。

#### 3、计算值 Computed

计算属性值实际上是一类衍生值，它是根据现有的状态或者其他值计算而来，原则上在计算属性中尽可能地不对当前状态做任何修改；同时对于任何可以通过现有状态数据得到的值都应该通过计算属性获取。
语法为：@computed get computesValue [function]；

#### 4、action

mobx推荐将**修改被观测变量**的行为放在action中
```bash
import {observable, action} from 'mobx';
class Store {
  @observable number = 0;
  @action add = () => {
    this.number++;
  }
}

const newStore = new Store();
newStore.add();
```
---
### mobx-react中核心概念
#### 1、observer
通过 @observer 将 React 组件转化成响应式组件，它用 mobx.autorun 包装了组件的 render 函数以确保任何组件渲染中使用的数据变化时都可以强制刷新组件

#### 2、Provider
Provider 组件用来包裹最外层组件节点，并且传入 store（通过）context 传递给后代组件。

#### 3、inject
使用 @inject 给组件注入其需要的 store（利用 React context 机制）；

---
### 严格模式 useStrict
在 mobx 中，可以有很多种方式去修改 state，mobx 并不对其做限制；
但是如果使用了严格模式：
``` bash
import { useStrict } from 'mobx';
useStrict(true);
```
那么将会限制开发者只能通过 @action 来修改 state，这将会更有利于组织代码以及使数据流更清晰。

---

### 在 React 中使用 Mobx

```bash
import React from 'react';  
import ReactDOM from 'react-dom';  
import { observable, action } from 'mobx';  
import { Provider, observer, inject } from 'mobx-react';

class CounterModel {  
    @observable
    count = 0

    @action
    increase = () => {
        this.count += 1;
    }
}

const counter = new CounterModel();

@inject('counter') 
@observer
class App extends React.Component {  
    render() {
        const { count, increase } = this.props.counter;

        return (
            <div>
                <span>{count}</span>
                <button onClick={increase}>increase</button>
            </div>
        )
    }
}

ReactDOM.render(  
    <Provider counter={counter}>
        <App />
    </Provider>
);
```

### 总结
MobX 的理念是通过观察者模式对数据做出追踪处理，在对可观察属性的作出变更或者引用的时候，触发其依赖的监听函数，在 React 中既是在 @observer 中对组件进行数据更新并渲染到视图层面，其核心与开发模式和 Vue 非常相似。